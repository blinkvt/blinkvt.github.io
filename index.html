<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="whatever">
<meta property="og:type" content="website">
<meta property="og:title" content="Tinyblink&#39;s Blog">
<meta property="og:url" content="https://tinyblink.github.io/index.html">
<meta property="og:site_name" content="Tinyblink&#39;s Blog">
<meta property="og:description" content="whatever">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tinyblink&#39;s Blog">
<meta name="twitter:description" content="whatever">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://tinyblink.github.io/">





  <title>Tinyblink's Blog</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tinyblink's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">言而有物</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tinyblink.github.io/2019/04/30/jvm-start-up/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tinyblink">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tinyblink's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/30/jvm-start-up/" itemprop="url">调试JDK7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-30T01:20:01+08:00">
                2019-04-30
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>老早就知道JDK使用C++编写，但一直以来在硬看源码的状态，这次终于借排查问题的机会来调试了一把JDK7。<br>从调试过程中看，JDK7大概处于被弃用的状态，坑挺多</p>
</blockquote>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>   在agent attach到jvm进程后JDK7出现了偶现的<a href="https://bugs.openjdk.java.net/browse/JDK-8168508" target="_blank" rel="noopener">crash</a>，看crash日志发现是hotspot/src/share/vm/classfile/dictionary.cpp的类卸载方法抛出的错<code>defining loader should not be live if klass is not</code>，这个类顾名思义是用力保存类信息的，它基于Hash表保存了已加载的类信息。抛错的代码如下图所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The loader in this entry is alive. If the klass is dead,</span></span><br><span class="line"><span class="comment">// the loader must be an initiating loader (rather than the</span></span><br><span class="line"><span class="comment">// defining loader). Remove this entry.</span></span><br><span class="line"><span class="keyword">if</span> (!is_alive-&gt;do_object_b(e)) &#123;</span><br><span class="line">        guarantee(!is_alive-&gt;do_object_b(k_def_class_loader),</span><br><span class="line">    <span class="string">"defining loader should not be live if klass is not"</span>);</span><br></pre></td></tr></table></figure>
<p>guarantee条件不满足时触发crash，在java8中，这个判断检测被移除，大概作者意识到这个判断有时是错误的。（但究竟会什么时候会出现类判定死掉而定义它的类加载器还活着的情况？）<br>JVM对于Java开发者来说是个黑盒，尤其内部的bug，一般只能从官网的bug列表中获得解决办法，为了排查这个问题，希望在抛错的地方打印一些上下文信息（落入这个条件的类名和类加载信息）。但为验证添加加的代码没问题，首先得先debug到这块。于是开始踏上编译调试jdk7的踩坑之旅。</p>
<h1 id="踩坑过程"><a href="#踩坑过程" class="headerlink" title="踩坑过程"></a>踩坑过程</h1><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><p>编译的源码在<a href="https://hg.openjdk.java.net/jdk7u/jdk7u/raw-file/tip/README-builds.html#centos" target="_blank" rel="noopener">openjdk官网上</a></p>
<p>hg clone <a href="http://hg.openjdk.java.net/jdk7/jdk7" target="_blank" rel="noopener">http://hg.openjdk.java.net/jdk7/jdk7</a> YourOpenJDK<br>cd YourOpenJDK<br>sh ./get_source.sh<br>比较慢 耐心等,<a href="http://www.mopzoo.com/article/15" target="_blank" rel="noopener">有网址错误的问题</a>,可能是JDK7实在有点老了吧，就连原先提供全量依赖安装包的<a href="https://download.java.net/openjdk/jdk7" target="_blank" rel="noopener">网址</a>也失效了, 这里我预先下载了一个openjdk-7u40.zip。</p>
<h2 id="下载依赖"><a href="#下载依赖" class="headerlink" title="下载依赖"></a>下载依赖</h2><p>根据官网上的说明下载依赖的包。</p>
<p>yum install -y alsa-lib-devel cups-devel gcc gcc-c++ freetype-devel libstdc++-static libX* zip</p>
<p>编译过程需要使用ant，手动安装 ant <a href="https://archive.apache.org/dist/ant/binaries/apache-ant-1.8.0-bin.tar.gz" target="_blank" rel="noopener">https://archive.apache.org/dist/ant/binaries/apache-ant-1.8.0-bin.tar.gz</a> 解压手动建个/usr/bin的软链。</p>
<p>Java7编译依赖于Java6，这个设定要求安装Java6，并且openjdk6不行，必须是oracle的，好不容易找到一个jdk-6u31-linux-x64-rpm.bin<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sh jdk-6u31-linux-x64-rpm.bin</span><br><span class="line"><span class="meta">$</span> ll *.rpm</span><br><span class="line"><span class="meta">$</span> sudo rpm -ivh jdk-6u31-linux-amd64.rpm</span><br><span class="line"><span class="meta">$</span> rpm -qa | grep ^jdk-1.6.0</span><br><span class="line">jdk-1.6.0_31-fcs.x86_64</span><br><span class="line"><span class="meta">$</span> rpm -ql jdk-1.6.0_31-fcs.x86_64</span><br><span class="line">/usr/java/jdk1.6.0_31 # Oracle JDK HOME</span><br></pre></td></tr></table></figure></p>
<h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><p>创建build.sh文件<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">export LANG=C</span><br><span class="line">export ALT_BOOTDIR=/usr/java/jdk1.6.0_31/</span><br><span class="line"></span><br><span class="line">export ALLOW_DOWNLOADS=true</span><br><span class="line"></span><br><span class="line">export HOTSPOT_JOBS=8</span><br><span class="line">export ALT_PARALLEL_COMPILE_JOBS=8</span><br><span class="line"></span><br><span class="line">export SKIP_COMPARE_IMGAGES=true</span><br><span class="line"></span><br><span class="line">export USE_PRECOMPILED_HEADER=true</span><br><span class="line"></span><br><span class="line">export BUILD_LANGTOOLS=true</span><br><span class="line">export BUILD_HOTSOPT=true</span><br><span class="line">export BUILD_JDK=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BUILD_DEPLOY=false</span><br><span class="line"></span><br><span class="line">BUILD_INSTALL=false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>这个可以不加，默认生成在当前目录中</span><br><span class="line"><span class="meta">#</span>export ALT_OUTPUTDIR=/opt/jdk/build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>包含全部的调试信息 !!! </span><br><span class="line">export ENABLE_FULL_DEBUG_SYMBOLS=1</span><br><span class="line"><span class="meta">#</span>调试信息是否压缩，如果配置为１,libjvm.debuginfo会被压缩成libjvm.diz,将不能被debug。 会报</span><br><span class="line"><span class="meta">#</span>Missing separate debuginfo for /opt/openjdk/build/linux-amd64-#debug/hotspot/outputdir/linux_amd64_compiler2/jvmg/libjvm.so</span><br><span class="line">export ZIP_DEBUGINFO_FILES=0</span><br><span class="line"></span><br><span class="line">unset JAVA_HOME</span><br><span class="line">unset CLASSPATH</span><br></pre></td></tr></table></figure></p>
<p>执行source ./build.sh 设置好环境变量</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>在openjdk源码路径下make sanity 检测编译环境是否有问题<br>直接编译还会碰到下面的坑<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> -XX:-PrintVMOptions -XX:+UnlockDiagnosticVMOptions -XX:-LogVMOutput -Xmx512m -Xms512m -XX:PermSize=32m -XX:MaxPermSize=160m -jar /opt/openjdk/build/linux-amd64/btjars/generatecurrencydata.jar -o /opt/openjdk/build/linux-amd64/lib/currency.data.temp \</span><br><span class="line">     &lt; ../../../src/share/classes/java/util/CurrencyData.properties</span><br><span class="line">Error: time is more than 10 years from present: 1136059200000</span><br><span class="line">java.lang.RuntimeException: time is more than 10 years from present: 1136059200000</span><br><span class="line">     at build.tools.generatecurrencydata.GenerateCurrencyData.makeSpecialCaseEntry(GenerateCurrencyData.java:285)</span><br><span class="line">     at build.tools.generatecurrencydata.GenerateCurrencyData.buildMainAndSpecialCaseTables(GenerateCurrencyData.java:225)</span><br><span class="line">     at build.tools.generatecurrencydata.GenerateCurrencyData.main(GenerateCurrencyData.java:154)</span><br></pre></td></tr></table></figure></p>
<p>这个问题也很坑，不知为什么当时设置了过期时间是10年，需要在 CurrentData文件中将类似VE=VEB;2006-01-01-04-00-00;VEF改成10年内的时间VE=VEB;2016-01-01-04-00-00;VE</p>
<p>执行make，20分钟左右编译成功（如果cpu内存大点可以编译的更快）<br>执行 make  debug_build  编译debug包，只有debug包才能用来调试。生成文件在<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/openjdk/build/linux-amd64-debug/hotspot/outputdir/linux_amd64_compiler2/jvmg</span><br></pre></td></tr></table></figure></p>
<p>路径下 。<br>至此编译完成，接下来进行调试。</p>
<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><h2 id="本地调试"><a href="#本地调试" class="headerlink" title="本地调试"></a>本地调试</h2><p>首先设置环境参数<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/java/jdk1.6.0_31</span><br><span class="line">export JRE_HOME=$JAVA_HOME/jre</span><br><span class="line">export LD_LIBRARY_PATH=/opt/openjdk/build/linux-amd64-debug/hotspot/outputdir/linux_amd64_compiler2/jvmg:/opt/openjdk/build/linux-amd64-debug/j2sdk-image/jre/lib/amd64:$LD_LIBRARY_PATH</span><br></pre></td></tr></table></figure></p>
<p>可以写个Helloworld测试<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/openjdk/build/linux-amd64-debug/hotspot/outputdir/linux_amd64_compiler2/jvmg/hotspot -gdb Hello</span><br></pre></td></tr></table></figure></p>
<p>也可以用以下方式调试<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb /opt/openjdk/build/linux-amd64-debug/hotspot/outputdir/linux_amd64_compiler2/jvmg/gamma </span><br><span class="line">handle SIGUSR1 nostop noprint</span><br><span class="line">handle SIGUSR2 nostop noprint</span><br><span class="line"></span><br><span class="line">set args Hello</span><br><span class="line"> b /opt/openjdk/hotspot/src/share/tools/launcher/java.c:1270</span><br><span class="line"> r</span><br></pre></td></tr></table></figure></p>
<h2 id="远程调试"><a href="#远程调试" class="headerlink" title="远程调试"></a>远程调试</h2><p>本地调试并不方便，为了方便使用。还有一种远程调试方案。</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>使用gdbserver启动程序打开端口。<br>yum list gdb*<br>安装gdbserver<br>虚拟机关掉防火墙<br>systemctl stop firewalld.service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>JAVA_HOME/bin/javac Hello.java</span><br><span class="line"></span><br><span class="line">gdbserver :1234 /opt/openjdk/build/linux-amd64-debug/hotspot/outputdir/linux_amd64_compiler2/jvmg/gamma Hello</span><br></pre></td></tr></table></figure>
<h3 id="调试端"><a href="#调试端" class="headerlink" title="调试端"></a>调试端</h3><h4 id="采用命令行调试"><a href="#采用命令行调试" class="headerlink" title="采用命令行调试"></a>采用命令行调试</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gdb gamma   (这里gamma不需要路径对应 但程序得有的）</span><br><span class="line">target remote 172.24.161.163:1234</span><br><span class="line">b java.c:1270 </span><br><span class="line">//b /opt/openjdk/hotspot/src/share/tools/launcher/java.c:1270</span><br><span class="line">源文件对应会从两个地方找 1.编译的时候的源文件路径2.当前gdb的路径，即在gdb种执行pwd显示的路径，可以用cd改变</span><br></pre></td></tr></table></figure>
<p>跟服务端环境最好一直，操作系统和gdb版本保持一致。</p>
<h4 id="采用-vscode-IDE调试"><a href="#采用-vscode-IDE调试" class="headerlink" title="采用 vscode IDE调试"></a>采用 vscode IDE调试</h4><p>vscode需要的gcc版本比较高，gcc安装也是个蛋疼的问题，一般需要一些工具来解决依赖问题。centos6 gcc版本较低，所以一般用centos7来安装vscode。<br>如果使用虚拟机这里也可能碰到分辨率不行的问题，需要用yum update 并安装virtualbox的增强版<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1) In the top toolbar in OSX, go to VirtualBox -&gt; Preferences -&gt; Display and change your max resolution size. My resolution was set to Automatic and the settings were too low. I changed this to Hint and it allowed me to specify my own Height and Width</span><br><span class="line">2) Start up the VM and log in if necessary. While it&apos;s running, click Devices -&gt; Insert Guest Additions CD Image... from the Mac toolbar. There should be some prompts on the VM&apos;s terminal then restart the VM when it&apos;s completed.</span><br></pre></td></tr></table></figure></p>
<p>vscode中打开源码vm 并编辑launch.json<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // Use IntelliSense to learn about possible attributes.</span><br><span class="line">    // Hover to view descriptions of existing attributes.</span><br><span class="line">    // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387</span><br><span class="line">    "version": "0.2.0",</span><br><span class="line">    "configurations": [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"(gdb) Launch"</span>,</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"cppdbg"</span>,</span><br><span class="line">            <span class="attr">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">            <span class="attr">"miDebuggerServerAddress"</span>: <span class="string">"172.24.160.62:1234"</span>,</span><br><span class="line">            <span class="attr">"program"</span>: <span class="string">"/root/gamma"</span>,</span><br><span class="line">            <span class="attr">"args"</span>: [],</span><br><span class="line">            <span class="attr">"stopAtEntry"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"cwd"</span>: <span class="string">"$&#123;workspaceFolder&#125;"</span>,</span><br><span class="line">            <span class="attr">"environment"</span>: [],</span><br><span class="line">            <span class="attr">"externalConsole"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"MIMode"</span>: <span class="string">"gdb"</span>,</span><br><span class="line">            // not easy to use</span><br><span class="line">           // "sourceFileMap": &#123;</span><br><span class="line">           //     "/opt/openjdk/hotspot": "/root/hotspot"</span><br><span class="line">           // &#125;,</span><br><span class="line">            "setupCommands": [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"description"</span>: <span class="string">"Enable pretty-printing for gdb"</span>,</span><br><span class="line">                    <span class="attr">"text"</span>: <span class="string">"-enable-pretty-printing"</span>,</span><br><span class="line">                    <span class="attr">"ignoreFailures"</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>sourceFileMap并不好用，不如直接把sourceFile全部拷贝到相同路径下。于是可以debug了。</p>
<h1 id="添加上下文"><a href="#添加上下文" class="headerlink" title="添加上下文"></a>添加上下文</h1><p>折腾这么久，终于装好环境，下面添加测试代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sun.misc.CompoundEnumeration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomClassLoader</span> <span class="keyword">extends</span> <span class="title">URLClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String selfPath = <span class="string">"agent.jar"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomClassLoader</span><span class="params">(String url)</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">"file:"</span> + url)&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Class&lt;?&gt; loadedClass = findLoadedClass(name);</span><br><span class="line">            <span class="keyword">if</span> (loadedClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                    resolveClass(loadedClass);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> loadedClass;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Class&lt;?&gt; aClass = findClass(name);</span><br><span class="line">                <span class="keyword">if</span> (resolve) &#123;</span><br><span class="line">                    resolveClass(aClass);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> aClass;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(name, resolve);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">getResource</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findResource(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;URL&gt; <span class="title">getResources</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Enumeration[] tmp = <span class="keyword">new</span> Enumeration[<span class="number">1</span>];</span><br><span class="line">        tmp[<span class="number">0</span>] = findResources(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CompoundEnumeration&lt;&gt;(tmp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ClassLoader agentClassLoader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        agentClassLoader = <span class="keyword">new</span> CustomClassLoader(selfPath);</span><br><span class="line">        Class c = ((CustomClassLoader) agentClassLoader).loadClass(<span class="string">"com.fasterxml.jackson.databind.MappingJsonFactory"</span>);</span><br><span class="line">        System.out.println(c);</span><br><span class="line">        agentClassLoader = <span class="keyword">null</span>;</span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Boostrap类加载器（null），不会跑到unloading的逻辑，所以这里声明了自定义的类加载器。</p>
<p>gdb打开端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdbserver :1234 /opt/openjdk/build/linux-amd64-debug/hotspot/outputdir/linux_amd64_compiler2/jvmg/gamma CustomClassLoader</span><br></pre></td></tr></table></figure>
<p>在另一台vscode上进行调试，加上断点，在Debug_Console中测试。<br>通过debug 调试加入的代码。<br><strong>thread.cpp 的create_vm即是JVM启动的主入口 ，至此打开了JVM的大门</strong></p>
<p>但我这次是不打算进去的，只是想添加点代码。</p>
<p>加入如下代码： </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!is_alive-&gt;do_object_b(e)) &#123;</span><br><span class="line">         <span class="keyword">if</span>(is_alive-&gt;do_object_b(k_def_class_loader))&#123;</span><br><span class="line">             <span class="keyword">char</span> ret[<span class="number">512</span>];</span><br><span class="line">            <span class="built_in">strcpy</span>(ret,<span class="string">"MT_ERROR:\nclassInfo: "</span>);</span><br><span class="line">            <span class="built_in">strcat</span>(ret,ik-&gt;external_name());</span><br><span class="line">            <span class="built_in">strcat</span>(ret,<span class="string">"\nclassLoaderInfo: "</span>);</span><br><span class="line">            e-&gt;print_value();</span><br><span class="line">          <span class="built_in">strcat</span>(ret,k_def_class_loader-&gt;print_value_string());</span><br><span class="line">          k_def_class_loader-&gt;print_value();</span><br><span class="line">          <span class="built_in">strcat</span>(ret,<span class="string">"\ndone"</span>);</span><br><span class="line">          guarantee(<span class="literal">false</span>,ret);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>排查结果待续…</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tinyblink.github.io/2019/04/29/hdr/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tinyblink">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tinyblink's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/29/hdr/" itemprop="url">HDR</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-29T00:20:01+08:00">
                2019-04-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>人眼睛可以根据观察的东西的远近和当下光线情况进行调。</p>
<p>照相机通过镜头伸缩调整焦距来拍摄不同远近的事物，但对光线的处理还是比人眼要弱的。它只能选择不同的曝光来拍摄不同光强下的景色，对于那种光影交错，光亮范围特别广，亮处暗处细节均很突出的场景来说就就显得乏力了，选择某一种曝光只会顾此失彼，而选择中间的曝光两头的细节均不会突出。</p>
<p>这个问题本质上是因为人的眼睛在关注景色的时候会自动调节，而对相机来说整个画面在拍摄的时候就已经确定下来了，是线性的，所以不得不采用后期补偿方式来解决这个问题，尽量还原真实情况。</p>
<p>HDR(高动态范围)是处理这一图像问题的技术，它核心思想是通过不同曝光的图片源来获得亮出和暗处的细节情况，通过将整体的像素重新在0-255间进行分配(tonemapping)来表现真实的场景，它会保留亮出和暗处对比度高的像素，对比如重点采集曝光度高的照片暗处的细节，曝光度低的照片亮处的细节。</p>
<p><img src="/2019/04/29/hdr/hdr.png" alt="hdr"></p>
<h2 id="融合"><a href="#融合" class="headerlink" title="融合"></a>融合</h2><p>以上这一过程是HDR中<code>fusion</code>的过程，算法是很成熟的，思路也比较多，个人觉得比较好的是通过<code>拉普拉斯图像金字塔</code>来做，给细节突出的(周边像素块对比度高)，色彩丰富的(rgb方差大)更高的权重，迭代不同的像素窗口块，高频和低频采用不通的加权策略，最后达到合成效果。</p>
<h2 id="校准"><a href="#校准" class="headerlink" title="校准"></a>校准</h2><p>融合这一问题其实并不复杂，photoshop中甚至可能采取单张图片拉亮度mapping的方式来解决(当然单张图片难免丢失细节，肯定不如多张图片好)。<br>HDR中比较复杂的是多张图片的校准问题。如何获取多张不同曝光下同一场景的照片，有两种方式</p>
<ul>
<li><p>单摄像头<br>这种方式的问题在于需要从软件的层面进行校准。局部运动和全局运动存在因未校准导致的鬼影（ghost）问题。<br>对于全局运动，需要找到不同曝光图像间的位移。这里只考虑水平和数值两个方向的移动，如果是相同曝光度的话，相对位移其实可以采用金字塔的迭代方式一致，先从大维度将突破缩小n方，上下左右移动后以及不动五种情况比对下，统计差别最小的选为移动方向(x,y)，第二次迭代(2x,2y)然后再移动比对下，以此迭代。<br>多曝光的图片，不能直接通过比对像素值来进行统计，因为高曝光的较亮部分肯定是噪音比较多，置信值比较少；地曝光较暗的部分置信值比较少。这里采用的解决方案是抓住不变的东西——去掉不可置信的点外的所有像素中间值不同曝光图片应该也是一样的。所以这里的解决办法就是使用这样的中指，将整张图片划分为二值图。然后再进行上面的迭代。</p>
<p><strong>单摄像头多张连续曝光来进行图片校准合成HDR在校准问题上缺陷较为明显：全局运动来说，单靠手拿着摄像头很难保证不发生远近移动或旋转移动(摄影爱好者会用三脚架来拍），软件层面难以校准；局部运动来说有遮挡覆盖的问题，多张不同曝光的图片提供信息有限，一直高低间隔曝光的视频可以提供更多的信息，但合成这样的HDR视频也还是有问题的，要引入运动检测，对一些局部移动还是难以根除遮挡的情况，使用image-inpainting之类推测的图像技术也不能保证一定有效。除此之外这种方式获取HDR视频要求硬件以至少2倍速切换曝光拍照，并不友好</strong></p>
<p><strong>可见单摄像头多曝光度拍照的技术问题多多，并不容易落地。但软件层面可以做的事情很多，复合了运动检测问题，也有更多的信息，可写的地方很多，所以此类论文绵绵不绝。然而最终HDR成熟落地的却是使用另一种方案</strong></p>
</li>
<li>多摄像头<br>多摄像头分别不同曝光拍摄。局部运动方面由于同一时刻拍摄，没有局部运动的情况；全局运动方面，由于两个摄像头在一个平面上紧靠着，且焦点都是向前的，所以可以认为只存在2D的平移。<br>双摄像头基本已成为手机的标配，可以采集更多的信息：包括色彩，景深等等，配合高性能GPU渲染更出色的照片。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tinyblink.github.io/2019/04/28/jvmgc/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tinyblink">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tinyblink's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/28/jvmgc/" itemprop="url">垃圾回收</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-28T01:03:41+08:00">
                2019-04-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>汽车分手动挡和自动挡。手动挡油耗低，司机可以掌控的更多，缺点是需要更多的操作，碰到紧急情况也容易手忙脚乱；自动挡对于司机来说操作更简单，需要关心的更少，缺点是性能比不上手动挡。<br>类似的权衡也存在于编程语言中，编程语言面临内存分配之后回收的问题，是自动回收还是手动回收？手动回收效率更高，可以掌控的更多，但人毕竟不可避免犯错误，可能会引发内存泄漏，并且开发效率也不高；而自动回收将这件事交给了垃圾回收器，开发者从垃圾回收的问题中解放出来。<br>就像现在大多数的车都是自动挡，甚至向无人驾驶方面演进一样，流行的编程语言都有一套垃圾回收机制。比如Java有JVM GC，Go也有自己的runtime负责GC，即使是比较底层的C++，也提供并建议使用智能指针，相当于半自动的GC。<br>垃圾回收有两种算法实现：</p>
<ul>
<li><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><p>  C++的智能指针采用这种方式，对象在退出栈前会检查自身的引用数是否为0，是的话就进行析构。这种方式有两个缺点，一是循环引用，智能指针中引入weak_ptr来解决；二是效率并不高，多线程情况下临界区一般要加锁操作、当然C++这里用了原子操作来保证销毁或是创建的次数不会错乱。然而在对象多线程连续销毁创建的时候性能是很差的，有些C++程序会用对象池，并延后进行销毁，规避不必要的连续销毁创建过程。</p>
</li>
<li><h3 id="可达性分析"><a href="#可达性分析" class="headerlink" title="可达性分析"></a>可达性分析</h3><pre><code>JVM的垃圾回收采取的是就是可达性分析。可达性分析指从GCRoot开始，被引用的对象均可标记为活着的对象。GCRoot包括
    - 系统类加载器加载的类，
    - 活着的线程
    - Java栈上的局部变量
    - JNI方法的局部变量
    - 全局的JNI引用
    - 监控对象
    - JVM保留对象等
</code></pre></li>
</ul>
<h2 id="JVM中的对象生命周期"><a href="#JVM中的对象生命周期" class="headerlink" title="JVM中的对象生命周期"></a>JVM中的对象生命周期</h2><p>在Java中对象分配销毁的过程由JVM代理实现，一定程度上解放了开发者。但是在出问题的时候开发者还是需要了解JVM的内部机制，其中GC就是很重要的机制。</p>
<h3 id="对象分配"><a href="#对象分配" class="headerlink" title="对象分配"></a>对象分配</h3><p>在对象创建时首先会通过逃逸分析看是否对象可以直接在栈上分配(一种优化)，不行的话会在Java线程私有的一块区域TLAB上分配(一种无锁优化，只分配小对象)，否则的话开始在堆上分配。<br>那么如何在堆上分配，或者说堆如何设计才能使得效率最高呢。</p>
<h3 id="对象回收"><a href="#对象回收" class="headerlink" title="对象回收"></a>对象回收</h3><p>对象在堆中分配方面抓住一个核心的规律：<code>绝大多数(90%)对象是朝生夕死的，存活下来的往往会存活的很长。扯开点说 这也是一种自然规律，类似的：马太效应，长尾效应，资本主义自由竞争终归会贫富悬殊，形成趋势后很难逆转，食物链低端微不足道的千千万万供养顶端的一个</code>。<br>划分成这两种不同的模式后需要采用不通的GC策略才能达到整体最有效果。分代的优势是young区效率足够高 能够应对对象快速分配，典型算法有CMS</p>
<ul>
<li>YGC<br>在young区，采用的是copy 清理算法，因为大部分的对象都会死掉，所以GC时直接copy存活的就行，效率是要比标记高的。在Eden区满了后会将存活的copy到s0区，下次YGC的时候s0区和Eden区中存活的再copy到s1区，倒来倒去，周而复始。当达到一定次数后将年纪过大的对象丢到老年代。当然也有一些其他情况对象会直接进入老年代，比如对象太大,E区放不下。<br>copy算法的效率虽高，但是毕竟浪费一块内存，所以S区不能太大，否则浪费内存的同时STW的时间也过长。</li>
<li>OldGC<br>在old区常用的算法是CMS GC，这是一种标记清理方式。其步骤可以分为：1.初始标记 2.并发标记 3.重新标记 4.并发清理，5并发重置。 stw在1 和 3。</li>
</ul>
<p><code>CMS GC的优点是吞吐较高，缺点是 1. 时间长，不可控，会随着堆的扩大而扩大; 2. 标记清理的方式原地回收，会有内存碎片的问题，默认在searial full gc的时候才会进行压缩整理</code></p>
<h3 id="其他算法"><a href="#其他算法" class="headerlink" title="其他算法"></a>其他算法</h3><ul>
<li>G1<br>G1 整个堆划分成一个个小堆区，每次对更小的Region堆进行GC，减少停顿。回收玩后存活对象移动到其他Region，减少总的停顿时间，并且移动的过程也减少了内存碎片。<br>这种Region的方式跟分片有点像。考虑到一整个大的可能有的索引慢和并发问题，分成小片可以减少相互关联和并发影响，提升总体性能。<br>在Java9之后G1作为默认GC，将CMS逐渐废弃，两代的GC难以满足大堆、低停顿时间的现代应用要求(毕竟吞吐降低相对进程STW来说更容易接受，更强的硬件条件可以缓解，但分代这种算法显然是不可扩展的)</li>
<li>ZGC<br>ZGC可以将GC时间控制在10ms内，并且GC停顿时间不再随着堆的扩大而变大;并且它是标记压缩的算法，没有内存碎片的问题。它只扫GCRoot，这个过程需要stw，但由于GCRoot（活跃的对象的引用）有限，基本只跟线程数有关，所以停顿短时间极端，在标记和清理阶段也几乎没有停顿，原理是利用着色指针（直接在指针上标记对象状态，通过原子操作比较）和读屏障（保证多线程可见性）来保证并发控制。  之后会compact，进行remap重定位，将活着的对象移动到另一个Region，整体回收原来的Region，这个并发控制也是利用着色指针和读屏障来保证。当然这种方式也有代价，就是吞吐会下降。多线程嘛，必然有竞态下的消耗。不像stw后操作，安全，单线程。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://tinyblink.github.io/2019/04/27/Agent实现总结/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tinyblink">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tinyblink's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/27/Agent实现总结/" itemprop="url">Agent实现总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-27T12:20:01+08:00">
                2019-04-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Agent原理"><a href="#Agent原理" class="headerlink" title="Agent原理"></a>Agent原理</h1><p>业务通过JVMTI来和JVM进行通信，各种profiler和debugger均通过此方式获取Java进程的具体运行状态。</p>
<p>动态修改字节码也是基于JVMTI，可以实现将一个agent jar动态attach到Java进程中去，并支持动态修改已加载获即将加载的类的字节码。</p>
<p><img src="/2019/04/27/Agent实现总结/attach.png" alt="How to Attach"></p>
<p><strong>这种方式的优点是对于上层业务方来说是透明的，规避了接入升级和兼容冲突的烦恼。但编写agent却并非易事，而且很容易碰触到JVM抛出的异常，甚至导致JVMcrash。错误大部分是因为对底层的JVM规则不了解，字节码编织有bug；但也可能JVM自身的bug</strong></p>
<h1 id="需要注意的点"><a href="#需要注意的点" class="headerlink" title="需要注意的点"></a>需要注意的点</h1><h2 id="减少依赖"><a href="#减少依赖" class="headerlink" title="减少依赖"></a>减少依赖</h2><p>作为agent程序，从避免侵入的角度，保持最小的jar包依赖是十分必要的。</p>
<p>第三方依赖包的行为难以预测。比如使用了<code>Jackson</code>库，attach出现以下两个问题：</p>
<blockquote>
<p>Jackson库是Java中序列化库，功能丰富、性能好，跟fastjson相比代码质量和可扩展更好，底层也有用到ASM。</p>
</blockquote>
<ul>
<li><p><strong>类加载过程报错</strong><br><code>Jackson</code>可能有LinkageError报错</p>
<p>  <img src="/2019/04/27/Agent实现总结/linkageerror.jpeg" alt="LinkageError"></p>
<p><code>Jackson</code>也有VerifyError报错，虽然是由agent用自定义的类加载器加载的，道理上是隔离的。但是在agent第一次attach的时候会也用默认的类加载器将agent.jar加载进来，这时源程序中如果也依赖了<code>Jackson</code>库的话，默认类加载器会有两个地方的Jackson jar包加载, 在同一时刻加载有可能报错。</p>
<p><img src="/2019/04/27/Agent实现总结/verifyerror1.png" alt="VerifyError"></p>
<p><img src="/2019/04/27/Agent实现总结/verifyerror2.png" alt="VerifyError"></p>
<p>这类Error锅需要甩给JDK，在6之后引入了stackframe maps之后，它本身的作用是提高运行时校验效率，stackframeTable是在编译时生成于字节码code属性最前面，运行时直接让jvm获得类型，但如果发现运行时的类型和编译时不一致就会跑出Error。本身性能提升多少不说，但对于写字节码的工具来说相当<a href="http://chrononsystems.com/blog/java-7-design-flaw-leads-to-huge-backward-step-for-the-jvm" target="_blank" rel="noopener">不友好</a>，而且在8之后这个特性还是必须支持的，除非制定参数-noverify。ASM在处理这个stackframeTable也是花了好几个版本才修复，可以在classWriter中通过compute_max|compute_frame来自定生成栈，减少开发难度(但也会降低开发降低效率)。<br>具体原因可能是<a href="https://stackoverflow.com/questions/28727501/compute-frames-issue-with-asm-and-stackframe-maps-in-generated-code" target="_blank" rel="noopener">使用asm编写的字节码有问题</a>, 也可能是同时加载两个jar包引起的，这个错网上stackoverflow上搜索<code>Bad type on operand stack</code> 会有一堆错，比如<a href="https://stackoverflow.com/questions/48131766/spark-job-failing-on-jackson-dependencies" target="_blank" rel="noopener">这个</a>就十分类似，具体是因为一开始编译时的类是某个类型，但在运行时却因为某些原因，比如jackson动态设置了moudle，使得抽象的属性被赋了具体的实现子类，从而跟原先类型不一致，导致了stackframesmap检查报错。尤其attach这种<strong>动态加载</strong>的操作。</p>
<blockquote>
<p>要防止同一个类加载器加载两个相同类的情况</p>
</blockquote>
</li>
</ul>
<ul>
<li><strong>类卸载困难</strong><br><code>Jackson</code> 库中默认初始化中有对象和线程进行了绑定，并放在缓存中，导致在发生gc的时候即使将自定义的类加载器进行清空，由于gcroot检查可达性会将这些对象视为存活对象从而不进行回收。</li>
</ul>
<h2 id="仔细编写字节码"><a href="#仔细编写字节码" class="headerlink" title="仔细编写字节码"></a>仔细编写字节码</h2><p>如上面所说，对操作数栈的元素操作要小心。对于复杂操作，人工很难控制好，不已排查，通过compute_max|compute_frame可以不用去控制stackframe。</p>
<p>做好抽象和底层控制，避免堆砌代码，以至难以维护。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="tinyblink">
            
              <p class="site-author-name" itemprop="name">tinyblink</p>
              <p class="site-description motion-element" itemprop="description">whatever</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/tinyblink" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:wanghao.seed@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tinyblink</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        




  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=66033078";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
